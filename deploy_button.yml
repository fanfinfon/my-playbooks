---
- name: Deploy Button Cricute App (Auto-Fix USB)
  hosts: all
  become: yes
  vars:
    repo_url: "https://github.com/fanfinfon/button_cricute.git"
    app_folder: "/home/pi/button_cricute"

  tasks:
    - name: Ensure Git is installed
      apt: name=git state=present update_cache=yes

    - name: Clone the repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_folder }}"
        version: main
        force: yes

    # --- THE DETECTIVE ---
    - name: Find the real Arduino USB Port
      shell: "ls /dev/ttyACM* /dev/ttyUSB* 2>/dev/null | head -n 1"
      register: usb_device
      ignore_errors: yes

    - name: Fail if no Arduino is found
      fail:
        msg: "CRITICAL ERROR: No Arduino found plugged into USB!"
      when: usb_device.stdout == ""

    - name: Show what we found
      debug:
        msg: "Found Arduino at: {{ usb_device.stdout }}"

    # --- THE SURGEON ---
    - name: Update docker-compose to use the REAL port
      replace:
        path: "{{ app_folder }}/docker-compose.yaml"
        regexp: '/dev/ttyACM0'
        replace: "{{ usb_device.stdout }}"

    - name: Update docker-compose to use Privileged Mode
      lineinfile:
        path: "{{ app_folder }}/docker-compose.yaml"
        insertafter: 'restart: unless-stopped'
        line: '    privileged: true'

    # --- STOP & START (FIXED SYNTAX) ---
    - name: Stop old container
      shell:
        cmd: "docker compose down"
        chdir: "{{ app_folder }}"
      ignore_errors: yes

    - name: Start Docker
      shell:
        cmd: "docker compose up -d --build"
        chdir: "{{ app_folder }}"